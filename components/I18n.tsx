import React, { createContext, useContext, useEffect, useMemo, useState } from 'react';
import AsyncStorage from '@react-native-async-storage/async-storage';

type Locale = 'en' | 'id';
type Dict = Record<string, string>;

const resources: Record<Locale, Dict> = {
  en: {
    about_title: 'About This App',
    check_update: 'Check for Update',
    checking: 'Checking…',
    privacy_policy: 'Privacy Policy',
    terms: 'Terms of Service',
    support: 'Support',
    rate_app: 'Rate App',
    appearance: 'Appearance',
    language: 'Language',
    system: 'System',
    light: 'Light',
    dark: 'Dark',
    english: 'English',
    bahasa: 'Bahasa',
    // global labels
    profile: 'Profile',
    clicker: 'Clicker',
    about: 'About',
    users_manager: 'Users Manager',
    projects: 'Projects',
    outlets: 'Outlets',
    tasks: 'Tasks',
    menu: 'Menu',
    logout: 'Logout',
    // new
    app_settings: 'App Settings',
    attendance: 'Attendance',
    assessment: 'Assessment',
    quick_quiz: 'Quick Quiz',
    sales_report: 'Sales Report',
    sales_detail: 'Sales Detail',
    provinces: 'Provinces',
    cities: 'Cities',
    activation: 'Activation',
    projects_list: 'Projects List',
    admin_requests: 'Admin Requests',
    user_mgmt: 'User Mgmt',
  // profile
  login_required: 'Please log in to see your profile.',
  go_to_login: 'Go to Login',
  request_role: 'Request Role',
  role_request: 'Role Request',
  requested: 'Requested',
  reason: 'Reason',
  edit_profile: 'Edit Profile',
  personal_info: 'Personal Info',
  first_name: 'First Name',
  last_name: 'Last Name',
  phone: 'Phone',
  email: 'Email',
  request_new_role: 'Request New Role',
  select_role: 'Select Role',
  select_role_placeholder: 'Select a role...',
  role_reason_placeholder: 'Why do you need this role?',
  submit: 'Submit',
  cancel: 'Cancel',
  update: 'Update',
  invalid_phone: 'Invalid Phone',
  invalid_phone_msg: 'Please enter a valid Indonesian phone number, e.g. 81234567890',
  error: 'Error',
  select_role_error: 'Please select a role to request.',
  request_sent: 'Request Sent',
  request_submitted: 'Your request for a new role has been submitted.',
  province: 'Province',
  city: 'City',
  phone_id: 'Phone (Indonesia)',
  // clicker
  clicker_settings: 'Clicker Setting',
  haptics: 'Haptics',
  step: 'Step',
  share: 'Share',
  import: 'Import',
  export: 'Export',
  copy: 'Copy',
  clear: 'Clear',
    
  rename_variable: 'Rename variable',
  new_name: 'New name',
  new_variable: 'New variable...',
  // subtitles
  outlets_subtitle: 'View outlet details and status',
  provinces_subtitle: 'View and manage province list',
  cities_subtitle: 'View and manage city list',
  projects_overview_subtitle: 'View project details and status',
  activation_subtitle: 'View and manage activation requests',
  user_mgmt_subtitle: 'Manage user accounts and permissions',
  team_mgmt: 'Team Management',
  team_mgmt_subtitle: 'Area Managers, Iris TLs & BAs by Province',
  admin_requests_subtitle: 'Take or review role requests',
  add_project: 'Add New Project',
  activation_name: 'Activation Name',
  project_name: 'Project Name',
  project_type: 'Project Type',
  project_tier: 'Project Tier',
  add: 'Add',
  edit_project: 'Edit Project',
  creator: 'Creator',
  view_audit: 'View Audit',
  edit: 'Edit',
  delete: 'Delete',
  // filters & common
  oldest: 'Oldest',
  newest: 'Newest',
  reset: 'Reset',
  filters: 'Filters',
  filters_on: 'Filters • On',
  search: 'Search',
  status: 'Status',
  apply: 'Apply',
  // extra
  quick_sales_report: 'Quick Sales Report',
  task_management: 'Task Management',
  take_quiz: 'Take Quiz',
  approve: 'Approve',
  deny: 'Deny',
  history: 'History',
  search_outlet_or_id: 'Search outlet or ID',
  search_outlet_or_task: 'Search by outlet or task ID',
  // analytics/history
  timeframe: 'Timeframe',
  last_3_months: 'Last 3 months',
  last_6_months: 'Last 6 months',
  last_12_months: 'Last 12 months',
  qr: 'QR',
  srd: 'SRD',
  total: 'Total',
  avg_per_report: 'Avg per report',
  guinness_selling: 'Guinness Selling',
  srd_group: 'SRD Group',
  metric: 'Metric',
  stocks: 'Stocks',
  quick_sales_report_monthly: 'Quick Sales Report (Monthly)',
  sales_report_detail_monthly: 'Sales Report Detail (Monthly)',
  early_assessment_monthly: 'Early Assessment (Monthly)',
  attendance_monthly: 'Attendance (Monthly)',
  outlet_history: 'Outlet History',
  team_history: 'Team History',
  // user management / admin
  unknown_user: 'Unknown User',
  current_role: 'Current Role',
  created: 'Created',
  success: 'Success',
  access_denied: 'Access denied',
  no_permission: "You don't have permission to view this page.",
  edit_user: 'Edit User',
  role: 'Role',
  user: 'User',
  // audit logs
  audit_logs: 'Audit Logs',
  last_7_days: 'Last 7 days',
  last_30_days: 'Last 30 days',
  last_90_days: 'Last 90 days',
  refresh: 'Refresh',
  copy_csv: 'Copy CSV',
  all: 'All',
  all_actions: 'All actions',
  filter_by_actor: 'Filter by actor (id, name, or email)',
  filter_by_docid: 'Filter by docId',
  by: 'By',
  changed: 'Changed',
  load_more: 'Load more',
  admins_only: 'Admins only.',
  your_role: 'Your role',
  unknown: 'unknown',
  copied: 'Copied',
  copy_failed: 'Copy failed',
  // auth/login/signup
  missing_info: 'Missing Info',
  enter_email_password: 'Please enter email and password.',
  login_failed: 'Login Failed',
  welcome_back: 'Welcome Back',
  sign_in_continue: 'Sign in to continue',
  password: 'Password',
  password_placeholder: '••••••••',
  login: 'Login',
  no_account: "Don't have an account?",
  sign_up: 'Sign Up',
  create_account: 'CREATE ACCOUNT',
  get_started: 'Get Started',
  fill_information_below: 'Fill in the information below',
  first_name_placeholder: 'John',
  last_name_placeholder: 'Doe',
  phone_indonesia: 'Phone (Indonesia)',
  phone_placeholder: '81234567890',
  phone_format_hint: 'Format: +6281234567890',
  create_password: 'Create a password',
  repeat_password: 'Repeat password',
  passwords_do_not_match: 'Passwords do not match',
  missing_fields: 'Missing Fields',
  first_last_phone_required: 'First Name, Last Name, and Phone are required.',
  password_required: 'Password Required',
  enter_password: 'Please enter a password.',
  enter_valid_phone: 'Please enter a valid Indonesian phone number, e.g. 81234567890',
  signup_failed: 'Sign Up Failed',
  failed_create_user_data: 'Failed to create user data.',
  create_account_cta: 'Create Account',
  already_have_account: 'Already have an account?',
  // not found
  oops: 'Oops!',
  screen_not_exist: "This screen doesn't exist.",
  go_home: 'Go to home screen!'
  ,
  // about/updates
  app_version: 'App Version',
  build: 'Build',
  channel: 'Channel',
  runtime: 'Runtime',
  update_id: 'Update ID',
  unable_open_link: 'Unable to open link',
  update_ready: 'Update Ready',
  app_reload_apply: 'App will reload to apply the latest update.',
  reload: 'Reload',
  up_to_date: 'Up-to-date',
  latest_version: 'You have the latest version.',
  update_check_failed: 'Update Check Failed',
  // team management
  team_management: 'Team Management',
  name: 'Name',
  no_team_members: 'No team members found.'
  },
  id: {
    about_title: 'Tentang Aplikasi Ini',
    check_update: 'Periksa Pembaruan',
    checking: 'Memeriksa…',
    privacy_policy: 'Kebijakan Privasi',
    terms: 'Syarat Layanan',
    support: 'Dukungan',
    rate_app: 'Beri Nilai Aplikasi',
    appearance: 'Tampilan',
    language: 'Bahasa',
    system: 'Sistem',
    light: 'Terang',
    dark: 'Gelap',
    english: 'Inggris',
    bahasa: 'Bahasa',
    // global labels
    profile: 'Profil',
    clicker: 'Clicker',
    about: 'Tentang',
    users_manager: 'Manajer Pengguna',
    projects: 'Proyek',
    outlets: 'Outlet',
    tasks: 'Tugas',
    menu: 'Menu',
    logout: 'Keluar',
    // new
    app_settings: 'Pengaturan Aplikasi',
    attendance: 'Kehadiran',
    assessment: 'Penilaian',
    quick_quiz: 'Kuis Cepat',
    sales_report: 'Laporan Penjualan',
    sales_detail: 'Detail Penjualan',
    provinces: 'Provinsi',
    cities: 'Kota',
    activation: 'Aktivasi',
    projects_list: 'Daftar Proyek',
    admin_requests: 'Permintaan Admin',
    user_mgmt: 'Manajemen Pengguna',
  // profile
  login_required: 'Silakan masuk untuk melihat profil Anda.',
  go_to_login: 'Masuk',
  request_role: 'Minta Peran',
  role_request: 'Permintaan Peran',
  requested: 'Diminta',
  reason: 'Alasan',
  edit_profile: 'Ubah Profil',
  personal_info: 'Informasi Pribadi',
  first_name: 'Nama Depan',
  last_name: 'Nama Belakang',
  phone: 'Telepon',
  email: 'Email',
  request_new_role: 'Minta Peran Baru',
  select_role: 'Pilih Peran',
  select_role_placeholder: 'Pilih peran...',
  role_reason_placeholder: 'Mengapa Anda membutuhkan peran ini?',
  submit: 'Kirim',
  cancel: 'Batal',
  update: 'Perbarui',
  invalid_phone: 'Nomor Tidak Valid',
  invalid_phone_msg: 'Masukkan nomor telepon Indonesia yang valid, mis. 81234567890',
  error: 'Kesalahan',
  select_role_error: 'Silakan pilih peran yang diminta.',
  request_sent: 'Permintaan Terkirim',
  request_submitted: 'Permintaan peran baru Anda telah dikirim.',
  province: 'Provinsi',
  city: 'Kota',
  phone_id: 'Telepon (Indonesia)',
  // clicker
  clicker_settings: 'Pengaturan Clicker',
  haptics: 'Getar',
  step: 'Langkah',
  share: 'Bagikan',
  import: 'Impor',
  export: 'Ekspor',
  copy: 'Salin',
  clear: 'Bersihkan',
    
  rename_variable: 'Ganti nama variabel',
  new_name: 'Nama baru',
  new_variable: 'Variabel baru...',
  // subtitles
  outlets_subtitle: 'Lihat detail dan status outlet',
  provinces_subtitle: 'Lihat dan kelola daftar provinsi',
  cities_subtitle: 'Lihat dan kelola daftar kota',
  projects_overview_subtitle: 'Lihat detail dan status proyek',
  activation_subtitle: 'Lihat dan kelola permintaan aktivasi',
  user_mgmt_subtitle: 'Kelola akun pengguna dan perizinan',
  team_mgmt: 'Manajemen Tim',
  team_mgmt_subtitle: 'Area Manager, Iris TL & BA per Provinsi',
  admin_requests_subtitle: 'Terima atau tinjau permintaan peran',
  add_project: 'Tambah Proyek Baru',
  activation_name: 'Nama Aktivasi',
  project_name: 'Nama Proyek',
  project_type: 'Jenis Proyek',
  project_tier: 'Tingkat Proyek',
  add: 'Tambah',
  edit_project: 'Ubah Proyek',
  creator: 'Pembuat',
  view_audit: 'Lihat Audit',
  edit: 'Ubah',
  delete: 'Hapus',
  // filters & common
  oldest: 'Terlama',
  newest: 'Terbaru',
  reset: 'Atur Ulang',
  filters: 'Filter',
  filters_on: 'Filter • Aktif',
  search: 'Cari',
  status: 'Status',
  apply: 'Terapkan',
  // extra
  quick_sales_report: 'Laporan Penjualan Cepat',
  task_management: 'Manajemen Tugas',
  take_quiz: 'Ambil Kuis',
  approve: 'Setujui',
  deny: 'Tolak',
  history: 'Riwayat',
  search_outlet_or_id: 'Cari outlet atau ID',
  search_outlet_or_task: 'Cari berdasarkan outlet atau ID tugas',
  // analytics/history
  timeframe: 'Rentang waktu',
  last_3_months: '3 bulan terakhir',
  last_6_months: '6 bulan terakhir',
  last_12_months: '12 bulan terakhir',
  qr: 'QR',
  srd: 'SRD',
  total: 'Total',
  avg_per_report: 'Rata per laporan',
  guinness_selling: 'Penjualan Guinness',
  srd_group: 'Grup SRD',
  metric: 'Metrik',
  stocks: 'Stok',
  quick_sales_report_monthly: 'Laporan Penjualan Cepat (Bulanan)',
  sales_report_detail_monthly: 'Detail Laporan Penjualan (Bulanan)',
  early_assessment_monthly: 'Penilaian Awal (Bulanan)',
  attendance_monthly: 'Kehadiran (Bulanan)',
  outlet_history: 'Riwayat Outlet',
  team_history: 'Riwayat Tim',
  // user management / admin
  unknown_user: 'Pengguna Tidak Dikenal',
  current_role: 'Peran Saat Ini',
  created: 'Dibuat',
  success: 'Berhasil',
  access_denied: 'Akses ditolak',
  no_permission: 'Anda tidak memiliki izin untuk melihat halaman ini.',
  edit_user: 'Ubah Pengguna',
  role: 'Peran',
  user: 'Pengguna',
  // audit logs
  audit_logs: 'Log Audit',
  last_7_days: '7 hari terakhir',
  last_30_days: '30 hari terakhir',
  last_90_days: '90 hari terakhir',
  refresh: 'Muat ulang',
  copy_csv: 'Salin CSV',
  all: 'Semua',
  all_actions: 'Semua aksi',
  filter_by_actor: 'Filter berdasarkan aktor (id, nama, atau email)',
  filter_by_docid: 'Filter berdasarkan docId',
  by: 'Oleh',
  changed: 'Diubah',
  load_more: 'Muat lebih banyak',
  admins_only: 'Hanya admin.',
  your_role: 'Peran Anda',
  unknown: 'tidak diketahui',
  copied: 'Disalin',
  copy_failed: 'Gagal menyalin',
  // auth/login/signup
  missing_info: 'Data Kurang',
  enter_email_password: 'Masukkan email dan kata sandi.',
  login_failed: 'Gagal Masuk',
  welcome_back: 'Selamat Datang Kembali',
  sign_in_continue: 'Masuk untuk melanjutkan',
  password: 'Kata Sandi',
  password_placeholder: '••••••••',
  login: 'Masuk',
  no_account: 'Belum punya akun?',
  sign_up: 'Daftar',
  create_account: 'BUAT AKUN',
  get_started: 'Mulai',
  fill_information_below: 'Isi informasi di bawah',
  first_name_placeholder: 'Budi',
  last_name_placeholder: 'Santoso',
  phone_indonesia: 'Telepon (Indonesia)',
  phone_placeholder: '81234567890',
  phone_format_hint: 'Format: +6281234567890',
  create_password: 'Buat kata sandi',
  repeat_password: 'Ulangi kata sandi',
  passwords_do_not_match: 'Kata sandi tidak cocok',
  missing_fields: 'Kolom Wajib',
  first_last_phone_required: 'Nama Depan, Nama Belakang, dan Telepon wajib diisi.',
  password_required: 'Kata Sandi Wajib',
  enter_password: 'Masukkan kata sandi.',
  enter_valid_phone: 'Masukkan nomor telepon Indonesia yang valid, mis. 81234567890',
  signup_failed: 'Gagal Daftar',
  failed_create_user_data: 'Gagal membuat data pengguna.',
  create_account_cta: 'Buat Akun',
  already_have_account: 'Sudah punya akun?',
  // not found
  oops: 'Ups!',
  screen_not_exist: 'Layar ini tidak ada.',
  go_home: 'Kembali ke beranda!'
  ,
  // about/updates
  app_version: 'Versi Aplikasi',
  build: 'Build',
  channel: 'Kanal',
  runtime: 'Runtime',
  update_id: 'ID Pembaruan',
  unable_open_link: 'Tidak dapat membuka tautan',
  update_ready: 'Pembaruan Siap',
  app_reload_apply: 'Aplikasi akan dimuat ulang untuk menerapkan pembaruan.',
  reload: 'Muat Ulang',
  up_to_date: 'Sudah terbaru',
  latest_version: 'Anda sudah versi terbaru.',
  update_check_failed: 'Gagal Memeriksa Pembaruan',
  // team management
  team_management: 'Manajemen Tim',
  name: 'Nama',
  no_team_members: 'Tidak ada anggota tim.'
  },
};

type Ctx = {
  locale: Locale;
  setLocale: (l: Locale) => void;
  t: (k: string) => string;
};

const I18nCtx = createContext<Ctx | undefined>(undefined);
const STORAGE_KEY = 'i18n.locale';

export function I18nProvider({ children }: { children: React.ReactNode }) {
  const [locale, setLocaleState] = useState<Locale>('en');

  useEffect(() => {
    (async () => {
      try {
        const saved = await AsyncStorage.getItem(STORAGE_KEY);
        if (saved === 'en' || saved === 'id') setLocaleState(saved);
      } catch {}
    })();
  }, []);

  const setLocale = (l: Locale) => {
    setLocaleState(l);
    AsyncStorage.setItem(STORAGE_KEY, l).catch(() => {});
  };

  const t = (k: string) => (resources[locale] && resources[locale][k]) || resources.en[k] || k;
  const value = useMemo(() => ({ locale, setLocale, t }), [locale]);
  return <I18nCtx.Provider value={value}>{children}</I18nCtx.Provider>;
}

export function useI18n() {
  const ctx = useContext(I18nCtx);
  if (!ctx) throw new Error('useI18n must be used within I18nProvider');
  return ctx;
}
